<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Daggerheart Encounter Tracker</title>
        <script src="adversaries.js"></script>
        <style>
            .slots {
                display: inline-block
            }
            .adversary {
                display: inline-block;
            }
            .adversary h3 {
                margin: 10px 0px;
            }
            .adversary p {
                margin: 7px 0px;
            }
        </style>
    </head>

    <body>
        <h1>Daggerheart Encounter Tracker</h1>
        <div id="encounters"></div>
    </body>

    <script>
        var encounters = [
            {
                "name": "Forest Ambush",
                "targetBattlePoints": 10, // Allows telling user they might need more or less adversaries
                "currentFear": 5, // Convenient. Also allows remembering fear state for different groups
                "playerTier": 1, // Needed to help calculate battle points, if adversary tiers differ
                "playerCount": 3, // Need to calculate minion battle points
                "description": "A group of bandits ambushes the party in a dense forest.",
                "adversaries": [
                    {
                        "name": "Bandit 1",
                        "originalName": "Jagged Knife Bandit",
                        "source": "SRD",
                        "tier": 1,
                        "type": "Standard",
                        // TODO: Description, motives/tactics, features, experiences, attacks
                        "difficulty": 12,
                        "majorThreshold": 8,
                        "severeThreshold": 14,
                        "hp": {
                            "slots": 5,
                            "marked": 3
                        },
                        "stress": {
                            "slots": 3,
                            "marked": 0
                        },
                        "modifications": [
                            {
                                "modificationName": "my cool debuff",
                                "propertyName": "majorThreshold",
                                "modification": "-1" // - or + to modify, or just a number to hard-set, mods are applied in order
                            }
                        ],
                        "conditions": [
                            "restrained",
                            "vulnerable"
                        ]
                    }
                ]
            }
        ];

        const adversaryRemovedEvent = new Event("adversaryRemoved");

        function createFearTracker(encounter) {
            var fearDiv = document.createElement("div");

            var fearValue = document.createElement("span");

            function updateFearDisplay() {
                fearValue.innerText = "Fear: " + encounter.currentFear;
            }
            updateFearDisplay();

            var useFearButton = document.createElement("button");
            useFearButton.innerText = "-";
            useFearButton.onclick = function() {
                if (encounter.currentFear > 0) {
                    encounter.currentFear--;
                    updateFearDisplay();
                }
            };

            var gainFearButton = document.createElement("button");
            gainFearButton.innerText = "+";
            gainFearButton.onclick = function() {
                if (encounter.currentFear < 12) {
                    encounter.currentFear++;
                    updateFearDisplay();
                }
            };

            fearDiv.appendChild(useFearButton);
            fearDiv.appendChild(fearValue);
            fearDiv.appendChild(gainFearButton);

            return fearDiv;
        }

        function updateResource(container, resource) {
            var elements = [];

            for (var i = 0; i < resource.slots; i++) {
                var slot = document.createElement("input");
                slot.type = "checkbox";
                if (i < resource.marked) {
                    slot.checked = true;
                }
                slot.onclick = function(event) {
                    if (event.target.checked) {
                        resource.marked++;
                    } else {
                        resource.marked--;
                    }
                    updateResource(container, resource);
                };
                elements.push(slot);
            }

            container.replaceChildren(...elements);
        }

        function createAdversaryElement(encounter, adversary) {
            var warning = "";
            if (adversary.tier > encounter.playerTier) {
                warning += "This adversary is above the player tier.";
            }

            var adversaryDiv = document.createElement("div");
            adversaryDiv.className = "adversary";
            adversaryDiv.innerHTML = `<h3>${adversary.name} (${adversary.originalName}, ${adversary.source})</h3>`;

            var tierAndType = document.createElement("p");
            tierAndType.innerText = `Tier ${adversary.tier} ${adversary.type}`;
            if (warning) {
                tierAndType.innerHTML += ` <span class="warning">(${warning})</span>`;
            }
            adversaryDiv.appendChild(tierAndType);

            var stats = document.createElement("p");
            var thresholds = "None";
            if (Number.isInteger(adversary.majorThreshold) && Number.isInteger(adversary.severeThreshold)) {
                thresholds = `${adversary.majorThreshold}/${adversary.severeThreshold}`;
            }
            stats.innerText = `Difficulty: ${adversary.difficulty} | Thresholds: ${thresholds}`;
            adversaryDiv.appendChild(stats);

            // TODO: See TODO in convertFromSRD for more stuff we can show

            var hpDiv = document.createElement("div");
            hpDiv.className = "slotInfo";
            hpDiv.innerHTML = "HP:";
            var hpSlotsDiv = document.createElement("div");
            hpSlotsDiv.className = "slots";
            updateResource(hpSlotsDiv, adversary.hp);
            hpDiv.appendChild(hpSlotsDiv);
            adversaryDiv.appendChild(hpDiv);

            var stressDiv = document.createElement("div");
            stressDiv.className = "slotInfo";
            stressDiv.innerHTML = "Stress:";
            var stressSlotsDiv = document.createElement("div");
            stressSlotsDiv.className = "slots";
            updateResource(stressSlotsDiv, adversary.stress);
            stressDiv.appendChild(stressSlotsDiv);
            adversaryDiv.appendChild(stressDiv);

            // TODO: Allow adding/deleting modifications
            // TODO: Reflect modifications in the stats
            var conditionsDiv = document.createElement("div");
            var conditionsDisplayDiv = document.createElement("div");
            conditionsDiv.appendChild(conditionsDisplayDiv)

            function updateConditionsDisplay() {
                conditionsDisplayDiv.innerHTML = "Conditions: ";
                if (adversary.conditions && adversary.conditions.length > 0) {
                    // TODO: Allow deleting conditions
                    conditionsDisplayDiv.innerText += adversary.conditions.join(", ");
                } else {
                    conditionsDisplayDiv.innerText += "None";
                }
            }

            updateConditionsDisplay();

            var addConditionsDiv = document.createElement("div");
            var addConditionInput = document.createElement("input");
            addConditionInput.type = "text";
            var addConditionButton = document.createElement("button");
            addConditionButton.innerText = "Add Condition";
            addConditionButton.onclick = function() {
                var condition = addConditionInput.value.trim();
                if (condition) {
                    adversary.conditions.push(condition);
                    addConditionInput.value = "";
                    updateConditionsDisplay();
                }
            };
            addConditionsDiv.appendChild(addConditionInput);
            addConditionsDiv.appendChild(addConditionButton);
            conditionsDiv.appendChild(addConditionsDiv);
            adversaryDiv.appendChild(conditionsDiv);

            var deleteButton = document.createElement("button");
            deleteButton.innerText = "Remove Adversary";
            deleteButton.onclick = function() {
                adversaryDiv.dispatchEvent(adversaryRemovedEvent);
            };
            adversaryDiv.appendChild(deleteButton);

            return adversaryDiv;
        }

        function addAdversary(container, encounter, adversary, refreshBattlePoints) {
            var adversaryElement = createAdversaryElement(encounter, adversary);
            adversaryElement.addEventListener("adversaryRemoved", function(event) {
                encounter.adversaries = encounter.adversaries.filter(function(a) {
                    return a !== adversary;
                });
                container.removeChild(adversaryElement);
                refreshBattlePoints();
            });
            container.appendChild(adversaryElement);
            refreshBattlePoints();
        }

        function convertFromSRD(srdAdversary) {
            var thresholds = srdAdversary.thresholds.split("/");
            return {
                name: srdAdversary.name + " (1)", // TODO: Naming
                originalName: srdAdversary.name,
                source: "SRD",
                tier: srdAdversary.tier,
                type: srdAdversary.type,
                difficulty: srdAdversary.difficulty,
                hp: {
                    slots: srdAdversary.hp,
                    marked: 0
                },
                stress: {
                    slots: srdAdversary.stress,
                    marked: 0
                },
                majorThreshold: parseInt(thresholds[0]),
                severeThreshold: parseInt(thresholds[1]),
            };
            // TODO: description, motives_and_tactics, attack, range, damage, experience, feats (name/text)
        }

        function calculateBattlePoints(encounter)
        {
            var currentBattlePoints = 0;
            for (var j = 0; j < encounter.adversaries.length; j++) {
                var adversary = encounter.adversaries[j];
                // TODO: Deal with tier differences
                switch(adversary.type) {
                    case "Minion":
                        currentBattlePoints += 1 / encounter.playerCount;
                        break;
                    case "Social":
                    case "Support":
                        currentBattlePoints += 1;
                        break;
                    case "Horde":
                    case "Ranged":
                    case "Skulk":
                    case "Standard":
                        currentBattlePoints += 2;
                        break;
                    case "Leader":
                    case "Elite":
                        currentBattlePoints += 3;
                        break;
                    case "Bruiser":
                        currentBattlePoints += 4;
                        break;
                    case "Solo":
                        currentBattlePoints += 5;
                        break;
                }
            }
            return currentBattlePoints;
        }

        var encountersDiv = document.getElementById("encounters");

        // TODO: Add ability to load encounters from JSON (should this append to current state, or replace it?)
        // TODO: Add ability to save encounters to JSON file
        // TODO: Save current state to localStorage (when, every modification?), and load it on startup

        // TODO: This is probably a silly way to do this, we
        //       don't actually want all these DOM elements.
        //       But it's an easy way to get that autocomplete for now.
        // TODO: Also, we want a broader search option, should be able
        //       to search by source, tier, and other arbitrary property text,
        //       and allow easier browsing.
        var srdDatalist = document.createElement("datalist");
        srdDatalist.id = "srd-adversaries";
        for (var i = 0; i < srdAdversaries.length; i++) {
            var option = document.createElement("option");
            option.value = srdAdversaries[i].name;
            srdDatalist.appendChild(option);
        }

        encountersDiv.appendChild(srdDatalist);

        // TODO: Actually, show one encounter at a time, and allow switching between them,
        //       as well as adding or deleting encounters.
        for (var i = 0; i < encounters.length; i++) {
            var encounter = encounters[i];
            var encounterDiv = document.createElement("div");
            encounterDiv.className = "encounter";
            encounterDiv.innerHTML = `<h2>${encounter.name} (Tier ${encounter.playerTier} | ${encounter.playerCount} Players)</h2><p>${encounter.description}</p>`;

            var fearDiv = createFearTracker(encounter);
            encounterDiv.appendChild(fearDiv);

            var battlePointsDiv = document.createElement("div");
            battlePointsDiv.innerHTML = `<p>Target Battle Points: ${encounter.targetBattlePoints} (<span name="current-battle-points"></span> left)</p>`;
            encounterDiv.appendChild(battlePointsDiv);

            function refreshBattlePoints() {
                var currentBattlePoints = calculateBattlePoints(encounter);

                // Round to nearest 0.1 for display
                var remainingBattlePoints = Math.round((encounter.targetBattlePoints - currentBattlePoints) * 10) / 10;

                battlePointsDiv.querySelector("[name='current-battle-points']").innerText = remainingBattlePoints;
            }

            var addAdversaryDiv = document.createElement("div");
            var srdSearch = document.createElement("input");
            srdSearch.type = "search";
            srdSearch.placeholder = "Search SRD Adversaries";
            srdSearch.setAttribute("list", "srd-adversaries");
            addAdversaryDiv.appendChild(srdSearch);
            encounterDiv.appendChild(addAdversaryDiv);

            var adversariesDiv = document.createElement("div");
            for (var j = 0; j < encounter.adversaries.length; j++) {
                addAdversary(adversariesDiv, encounter, encounter.adversaries[j], refreshBattlePoints);
            }
            encounterDiv.appendChild(adversariesDiv);

            var addAdversaryButton = document.createElement("button");
            addAdversaryButton.innerText = "Add Adversary";
            addAdversaryButton.onclick = function() {
                var selectedOption = srdSearch.value.trim();
                var srdAdversary = srdAdversaries.find(function(a) {
                    return a.name.localeCompare(selectedOption, undefined, { sensitivity: 'base' }) === 0;
                });
                if (srdAdversary) {
                    var adversary = convertFromSRD(srdAdversary);

                    encounter.adversaries.push(adversary);
                    addAdversary(adversariesDiv, encounter, adversary, refreshBattlePoints);
                }
            };
            addAdversaryDiv.appendChild(addAdversaryButton);

            encountersDiv.appendChild(encounterDiv);
        }
    </script>
</html>